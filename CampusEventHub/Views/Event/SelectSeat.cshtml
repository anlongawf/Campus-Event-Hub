@model CampusEventHub.Models.Event

@{
    ViewData["Title"] = "Chọn ghế - " + Model.EventName;
    var seatsByRow = Model.Seats.GroupBy(s => s.Row).OrderBy(g => g.Key);
}

@functions {
    string GetSeatClass(SeatStatus status)
    {
        return status switch
        {
            SeatStatus.Available => "seat-available",
            SeatStatus.Booked    => "seat-booked",
            SeatStatus.Reserved  => "seat-reserved",
            _ => "seat-available"
        };
    }
}


<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h3 class="mb-3">@Model.EventName</h3>
            <p class="text-muted">@Model.EventDate.ToString("dd/MM/yyyy HH:mm") - @Model.Location</p>

            <!-- Toggle View Mode -->
            <div class="mb-3">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" id="btn-view-3d">
                        <i class="fas fa-cube"></i> Xem 3D
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btn-view-2d">
                        <i class="fas fa-th"></i> Xem 2D
                    </button>
                </div>
            </div>

            <!-- Chú thích -->
            <div class="mb-4 p-3 border rounded bg-light">
                <h5>Chú thích:</h5>
                <div class="d-flex gap-4">
                    <div>
                        <span class="seat-legend seat-available"></span>
                        <small>Còn trống</small>
                    </div>
                    <div>
                        <span class="seat-legend seat-booked"></span>
                        <small>Đã đặt</small>
                    </div>
                    <div>
                        <span class="seat-legend seat-reserved"></span>
                        <small>Khóa bởi Khoa</small>
                    </div>
                    <div>
                        <span class="seat-legend seat-selected"></span>
                        <small>Đang chọn</small>
                    </div>
                </div>
            </div>

            <!-- Màn hình -->
            <div class="text-center mb-4">
                <div class="screen">STAGE / SCREEN</div>
            </div>

            <!-- 3D Seat Map -->
            <div id="seat-map-3d" class="seat-map">
                <canvas id="seatCanvas" style="width: 100%; height: 400px;"></canvas>
            </div>

            <!-- 2D Seat Map -->
            <div id="seat-map-2d" class="seat-map-2d" style="display: none;">
                <div class="seat-grid-container">
                    @foreach (var rowGroup in seatsByRow)
                    {
                        <div class="seat-row">
                            <div class="row-label">@rowGroup.Key</div>
                            <div class="seats-container">
                                @foreach (var seat in rowGroup.OrderBy(s => s.SeatNumber))
                                {
                                    var statusClass = GetSeatClass(seat.Status);

                                    <button class="seat-2d @statusClass"
                                            data-seat-id="@seat.SeatId"
                                            data-row="@seat.Row"
                                            data-number="@seat.SeatNumber"
                                            data-status="@((int)seat.Status)"
                                            @(seat.Status != SeatStatus.Available ? "disabled" : "")>
                                        @seat.SeatNumber
                                    </button>
                                }

                            </div>
                            <div class="row-label">@rowGroup.Key</div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar thông tin đặt ghế -->
        <div class="col-md-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Thông tin đặt ghế</h5>
                </div>
                <div class="card-body">
                    <div id="selected-seat-info">
                        <p class="text-muted">Vui lòng chọn ghế</p>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <strong>Sự kiện:</strong>
                        <p>@Model.EventName</p>
                    </div>
                    <div class="mb-3">
                        <strong>Thời gian:</strong>
                        <p>@Model.EventDate.ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                    <div class="mb-3">
                        <strong>Địa điểm:</strong>
                        <p>@Model.Location</p>
                    </div>
                    <div class="mb-3">
                        <strong>Điểm rèn luyện:</strong>
                        <p><span class="badge bg-success">@Model.TrainningPoint điểm</span></p>
                    </div>
                    <button id="btn-book-seat" class="btn btn-success w-100" disabled>
                        <i class="fas fa-check"></i> Xác nhận đặt ghế
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Pass data from server to JavaScript - PHẢI ĐẶT TRƯỚC KHI LOAD seat-selection.js
        window.seatData = @Html.Raw(Json.Serialize(Model.Seats.OrderBy(s => s.Row).ThenBy(s => s.SeatNumber)
                              .Select(s => new { s.SeatId, s.Row, s.SeatNumber, s.Status })));
        window.eventId = @Model.EventId;
        window.bookSeatUrl = '@Url.Action("BookSeat", "Event")';

        console.log('Seat data loaded:', window.seatData); // Debug log
    </script>
    <script src="~/js/seat-selection.js"></script>
}